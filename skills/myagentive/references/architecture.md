# MyAgentive Architecture Reference

## Project Structure

```
MyAgentive/
├── server/                         # Backend (Bun runtime)
│   ├── index.ts                    # Entry point, bootstraps application
│   ├── config.ts                   # Configuration loading, path resolution
│   ├── server.ts                   # Express server + WebSocket upgrade
│   ├── setup-wizard.ts             # First-run interactive setup
│   ├── version.ts                  # Version information (auto-generated by build)
│   ├── types.ts                    # TypeScript type definitions
│   ├── default-system-prompt.md    # Default system prompt
│   ├── default-user-prompt.md      # Default user prompt template
│   │
│   ├── core/
│   │   ├── ai-client.ts            # Claude Agent SDK integration
│   │   └── session-manager.ts      # Session orchestration + file delivery
│   │
│   ├── db/
│   │   ├── database.ts             # SQLite with bun:sqlite, WAL mode, embedded migrations
│   │   ├── migrations/             # Schema migrations (development fallback)
│   │   └── repositories/
│   │       ├── session-repo.ts     # Session CRUD + SDK session ID + pin/archive
│   │       └── message-repo.ts     # Message CRUD + metadata updates
│   │
│   ├── telegram/
│   │   ├── bot.ts                  # Grammy bot initialisation + middleware chain
│   │   ├── monitoring.ts           # Activity notifications to group (batched)
│   │   ├── subscription-manager.ts # Persistent Telegram subscriptions + response tracking
│   │   ├── message-session-tracker.ts # Message-to-session mapping for threads
│   │   ├── reply-mode.ts           # Reply threading modes (off/first/all)
│   │   └── handlers/
│   │       ├── command-handler.ts  # /start, /help, /session, /model, /compact, etc.
│   │       ├── message-handler.ts  # Text message processing + fragment buffer
│   │       └── media-handler.ts    # Voice, audio, document, video, photo, sticker
│   │
│   ├── auth/
│   │   ├── middleware.ts           # Web auth (password, token, API key)
│   │   └── telegram-auth.ts        # Telegram user ID verification
│   │
│   ├── services/
│   │   └── transcription.ts        # Deepgram audio transcription service
│   │
│   └── utils/
│       └── media-detector.ts       # MIME type detection, path validation, sensitive file blocking
│
├── client/                         # React + Tailwind CSS frontend (PWA)
│   ├── src/
│   │   ├── App.tsx                 # Main React component
│   │   ├── components/             # UI components
│   │   └── hooks/                  # Custom React hooks
│   └── index.html                  # Entry HTML
│
├── skills/                         # Agent skills (symlinked to .claude/skills/)
├── scripts/
│   ├── build-release.sh            # Build release packages (macOS + Linux)
│   ├── migrate.ts                  # Database migration runner
│   └── templates/                  # Release package templates
│       ├── install.sh              # Installation script
│       ├── myagentivectl           # Service control script
│       ├── send-file               # File delivery CLI
│       └── save-for-download       # Media save CLI
│
├── .claude/skills/ -> ../skills    # Symlink for SDK discovery (in dev)
├── package.json                    # Bun dependencies
└── tsconfig.json                   # TypeScript configuration
```

## Core Components

### Entry Point: server/index.ts

Bootstraps the application:
1. Checks if `~/.myagentive/config` exists
2. Runs setup wizard if missing
3. Loads config file into `process.env` (KEY=value parsing)
4. Changes cwd to config directory (for relative path resolution)
5. Dynamically imports modules (config, database, server, Telegram, monitoring, auth)
6. Runs database migrations
7. Sets up activity monitoring listener
8. Starts Express server + WebSocket
9. Starts Telegram bot (if configured)
10. Sends startup notification to monitoring group
11. Starts hourly expired token cleanup
12. Registers SIGINT/SIGTERM handlers for graceful shutdown

### Configuration: server/config.ts

Loads and resolves configuration:
- Primary: `~/.myagentive/config` (dotenv format)
- Fallback: `.env` in cwd (development)
- Resolves relative paths to absolute (relative to MYAGENTIVE_HOME)
- Exports typed `config` object

Key config properties:
```typescript
{
  port: number;                    // Server port (default 3847)
  nodeEnv: string;                 // production/development
  domain: string;                  // Server domain (default localhost)
  webPassword: string;             // Web interface password (required)
  apiKey: string;                  // REST API key (required)
  telegramBotToken: string;        // Bot token (empty = Telegram disabled)
  telegramUserId: number;          // Authorised user (0 = Telegram disabled)
  telegramEnabled: boolean;        // Computed: botToken && userId > 0
  telegramMonitoringGroupId: number | null;
  telegramAllowedGroups: number[]; // Groups where bot responds
  telegramGroupPolicy: "open" | "allowlist" | "disabled";
  telegramGroupPolicies: Record<string, "open" | "allowlist" | "disabled">;
  telegramReactionAck: boolean;    // Show eye reaction (default true)
  telegramFragmentBufferMs: number; // Message coalescence (default 500)
  telegramLinkPreview: boolean;    // Link previews (default true)
  databasePath: string;            // Absolute path to SQLite database
  mediaPath: string;               // Absolute path to media directory
  agentId: string;                 // Instance identifier
  deepgramApiKey: string;          // Deepgram API key for transcription
  isDev: boolean;                  // Computed
  isProd: boolean;                 // Computed
}
```

### AI Client: server/core/ai-client.ts

Wraps Claude Agent SDK's `query()` function:

**System Prompt Loading (Priority):**
1. `~/.myagentive/system_prompt.md` (installed by installer, overwritten on upgrade)
2. `server/default-system-prompt.md` (development fallback)
3. Embedded DEFAULT_SYSTEM_PROMPT constant (final fallback)

User prompt (`~/.myagentive/user_prompt.md`) is appended to system prompt if it has content.

Both prompts have `~` and `~/.myagentive` expanded to absolute paths.

**Project Root Resolution:**
- Compiled binary: parent of `bin/` directory (i.e. `~/.myagentive/`)
- Development: two levels up from `server/core/`

This determines where the SDK looks for `.claude/skills/`.

**MessageQueue Class:**
- Async iterable queue for multi-turn conversations
- `push(content)`: enqueue user message
- `close()`: signal end (resolves pending wait with null, not empty string)
- Async iterator yields messages, breaks on close

**AgentSession Class:**
```typescript
constructor(options: { resumeSessionId?: string })
sendMessage(content: string): void
getOutputStream(): AsyncGenerator<any>
close(): void
```

SDK query options:
```typescript
{
  prompt: messageQueue,           // Async iterable of user messages
  options: {
    maxTurns: 100,
    model: currentModel,          // "opus" | "sonnet" | "haiku"
    cwd: PROJECT_ROOT,            // For .claude/skills/ discovery
    settingSources: ['project'],  // Load project settings
    allowedTools: [
      "Bash", "Read", "Write", "Edit",
      "Glob", "Grep", "WebSearch", "WebFetch",
      "TodoWrite"
    ],
    systemPrompt: SYSTEM_PROMPT,
    pathToClaudeCodeExecutable: claudePath,  // If found
    resume: sdkSessionId,                     // If resuming
  }
}
```

**Claude Code Executable Search:**
- `$CLAUDE_CODE_PATH` (env var override)
- `/usr/local/bin/claude`
- `~/.local/bin/claude`
- `~/.claude/local/claude`
- nvm installations: `~/.nvm/versions/node/*/bin/claude`

**Model Switching:**
- `getCurrentModel()` / `setCurrentModel(model)`: runtime model preference
- Default: `opus`
- Applied when new AgentSession is created

### Session Manager: server/core/session-manager.ts

Central orchestrator for all chat sessions.

**ManagedSession Class:**
- Wraps AgentSession with subscriber management
- Tracks state: `isListening`, `isProcessing`, `isResetting`
- Media directory monitoring (outbox model)
- SDK session ID storage for resume

Key methods:
- `sendMessage(content, source)`: Queue message, detect concurrent processing, start listening
- `subscribe(clientId, clientType, callback)`: Register client for broadcasts
- `broadcast(message)`: Send to all subscribers
- `snapshotMediaDirectory()` / `findNewMediaFiles()`: Outbox file detection
- `resetAgentSession()`: Recover from errors (prevents concurrent resets)
- `handleSDKMessage(message)`: Route SDK output to appropriate broadcasts

**SDK Message Types Handled:**
- `system` (subtype `init`): Capture SDK session ID for resume
- `system` (subtype `status`, status `compacting`): Context compaction started
- `system` (subtype `compact_boundary`): Context compaction completed
- `assistant`: Text and tool_use blocks
- `result`: Completion with cost/duration, triggers file delivery detection

**File Delivery (Outbox Model):**
1. Before processing: snapshot all files in media directory (recursive scan)
2. After result: compare current files to snapshot
3. New files: determine media type from extension, compute web URL
4. Broadcast `file_delivery` to all subscribers
5. Persist delivered file metadata on the last assistant message

**SessionManager Class (Singleton):**
- Extends EventEmitter for activity events and session change notifications
- `getOrCreateSession(name, createdBy)`: Get from memory or create from database
- `listSessions(options)`: Query database for active/archived sessions
- `archiveSession / unarchiveSession`: Toggle archive flag
- `pinSession / unpinSession`: Pin/unpin sessions
- `renameSession(name, newTitle)`: Set display title
- `deleteSession(name)`: Close session, clear Telegram mappings, delete from database
- `subscribeClient / unsubscribeClient`: Manage client subscriptions
- `sendMessage(clientId, content, source)`: Route to client's session
- `broadcastFileDeliveryToAll(filePath, filename, caption)`: Used by send-file API

## Data Flow

```
User Message Flow:
─────────────────
1. User sends message via Telegram or Web
2. Handler receives message
3. SessionManager routes to ManagedSession
4. ManagedSession checks isProcessing (rejects concurrent messages)
5. Takes media directory snapshot
6. Stores user message in database
7. Broadcasts user_message to all subscribers
8. Emits activity event
9. Sends content to AgentSession (retry with reset on failure)
10. AgentSession passes to Claude SDK via MessageQueue

Response Streaming:
──────────────────
Claude SDK → AgentSession.getOutputStream() → ManagedSession.handleSDKMessage() →
  ├── assistant_message → storeAndBroadcastAssistant() → Database + All Subscribers
  ├── tool_use → Broadcast + Activity event
  ├── result → Broadcast + File delivery check + Mark processing complete
  ├── system/init → Capture SDK session ID → Database
  ├── system/compacting → Broadcast compacting event
  └── system/compact_boundary → Broadcast compacted event

File Delivery:
──────────────
Agent saves file → result event → findNewMediaFiles() → file_delivery broadcast →
  ├── Web: Inline media display
  └── Telegram: File attachment
```

## Database Schema

SQLite with WAL mode, bun:sqlite driver. Migrations embedded in database.ts for compiled binary, with fallback to server/db/migrations/ for development.

### sessions
```sql
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  name TEXT UNIQUE NOT NULL,
  title TEXT,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  archived INTEGER DEFAULT 0,
  pinned INTEGER DEFAULT 0,
  sdk_session_id TEXT,          -- For SDK session resume
  created_by TEXT DEFAULT 'web'
);
```

### messages
```sql
CREATE TABLE messages (
  id TEXT PRIMARY KEY,
  session_id TEXT NOT NULL,
  role TEXT NOT NULL,            -- 'user' | 'assistant'
  content TEXT NOT NULL,
  timestamp INTEGER NOT NULL,
  source TEXT,                   -- 'telegram' | 'web' | 'agent'
  metadata TEXT,                 -- JSON (mediaFiles, etc.)
  FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE
);
```

### auth_tokens
```sql
CREATE TABLE auth_tokens (
  id TEXT PRIMARY KEY,
  user_type TEXT NOT NULL,       -- 'web' | 'api'
  created_at INTEGER NOT NULL,
  expires_at INTEGER NOT NULL,
  last_used_at INTEGER
);
```

### media_files
```sql
CREATE TABLE media_files (
  id TEXT PRIMARY KEY,
  session_id TEXT,
  telegram_file_id TEXT,
  file_type TEXT NOT NULL,       -- 'voice' | 'audio' | 'document' | 'video' | 'photo'
  original_filename TEXT,
  stored_path TEXT NOT NULL,
  mime_type TEXT,
  file_size INTEGER,
  transcription TEXT,
  created_at TEXT NOT NULL
);
```

### activity_log
```sql
CREATE TABLE activity_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT,
  activity_type TEXT NOT NULL,
  summary TEXT,
  details TEXT,
  created_at INTEGER NOT NULL
);
```

### Additional Tables

- **sticker_descriptions**: Cache for Telegram sticker metadata
- **forum_topic_settings**: Telegram forum topic-to-session mapping
- **group_policies**: Per-group policy overrides
- **telegram_user_preferences**: Per-user Telegram settings
- **telegram_message_sessions**: Message-to-session mapping for reply threading
- **user_sessions**: Client session tracking

## Telegram Integration

### Bot Initialisation: server/telegram/bot.ts

Uses Grammy framework with middleware chain:
1. API throttler (30 msg/sec global, 1 msg/sec per chat)
2. Deduplication middleware (prevent processing duplicate updates)
3. Session middleware (user-specific state with currentSessionName)
4. Auth middleware (restrict to configured user ID)
5. Command handlers
6. Message/media handlers

### Subscription Manager: server/telegram/subscription-manager.ts

Manages persistent Telegram subscriptions:
- Subscribes chat IDs to sessions via SessionManager
- Tracks active responses with timeout (60 minutes default)
- Updates placeholder messages during processing
- Removes reactions on completion/timeout
- Handles Telegram API rate limits

### Reply Mode: server/telegram/reply-mode.ts

Manages reply-to threading:
- **off**: No reply threading
- **first**: Reply only to first message in conversation (default)
- **all**: Reply to each message separately

### Monitoring: server/telegram/monitoring.ts

Sends batched activity notifications to monitoring group:
- Rate-limited (2s minimum between flushes)
- Message queue with batching
- Formats events with emojis and timestamps
- Sends startup/shutdown messages
- Truncates to Telegram's 4096 character limit

## Web Interface

### Express Server: server/server.ts

Static file serving priority:
1. Development: `dist/` relative to server file
2. `$MYAGENTIVE_HOME/dist/` (installed binary)
3. Homebrew paths (`/opt/homebrew/opt/myagentive/share/myagentive/dist/`)
4. Fallback to `client/` (Vite dev server handles this)

### WebSocket Protocol

Connection: `ws://host:port/ws?token=<token>` or `?api_key=<key>`

Heartbeat: Server pings every 30 seconds, terminates dead connections.
Application-level ping/pong: For Cloudflare Tunnel compatibility (60s idle timeout).

### Client: client/

React + Tailwind CSS PWA:
- Session list sidebar with archive/pin support
- Chat interface with streaming message display
- Tool use visualisation
- Media file display (images, audio, video, documents)
- Context usage indicator
- Compaction status notifications
- Draft auto-save per session
- Authentication flow (password login)
- Real-time session list synchronisation via WebSocket

## Transcription Service: server/services/transcription.ts

Deepgram integration:
- Nova-2 model with smart formatting
- 25MB file size limit
- 10-second timeout
- Confidence threshold: 0.7 (warns on low confidence)
- Graceful fallback when no API key configured (returns null)
- Used by both web upload and Telegram media handlers

## Security

### Path Validation
- Media requests: validated within media directory (prevents directory traversal)
- File requests: limited to `~/.myagentive/` prefix
- Sensitive file blocking: `.env`, `credentials`, `id_rsa`, `id_ed25519`, `.pem`, `.key`, `private`, `secret`, `password`, `.ssh`
- File size limit: 50MB (MAX_MEDIA_SIZE)

### Authentication
- Web tokens: 7-day expiry, httpOnly cookies, SameSite=lax
- API key: No expiry, for programmatic access
- Telegram: User ID restriction, group allowlist
- Token cleanup: Hourly deletion of expired tokens

## Build & Release

### Build Process (scripts/build-release.sh)

1. Extract version from package.json
2. Update server/version.ts
3. Clean old release artifacts
4. Build frontend with Vite
5. Compile standalone binaries:
   - macOS ARM64 (Apple Silicon)
   - Linux x64
   - Linux ARM64
6. Package each with: binary, install.sh, myagentivectl, send-file, save-for-download, dist/, skills/, LICENSE, prompts
7. Create versioned tar.gz archives

### Installation (scripts/templates/install.sh)

1. Stop any running service
2. Create `~/.myagentive/bin/`, `data/`, `media/`, `memory/` directories
3. Migrate from old flat layout (if needed)
4. Copy binary and tools to `bin/`
5. Overwrite system_prompt.md (product-managed)
6. Copy user_prompt.md only if not existing
7. Clean and copy dist/ assets
8. Backup existing skills, then copy new skills
9. Create `.claude/skills` symlink for SDK
10. Create `~/.local/bin/` symlinks
