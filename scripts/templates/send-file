#!/bin/bash
# send-file - Explicitly send a file to the user via MyAgentive
#
# Usage: send-file <file-path> [caption]
#
# Examples:
#   send-file ~/.myagentive/media/videos/demo.mp4
#   send-file ~/.myagentive/media/videos/demo.mp4 "Here's your demo video!"
#   send-file /tmp/report.pdf "Quarterly report attached"
#
# If the file is not in ~/.myagentive/media/, it will be moved there first.

set -e

# Configuration
MYAGENTIVE_HOME="${MYAGENTIVE_HOME:-$HOME/.myagentive}"
MEDIA_DIR="$MYAGENTIVE_HOME/media"
SERVER_URL="${MYAGENTIVE_SERVER_URL:-http://localhost:3847}"
API_KEY_FILE="$MYAGENTIVE_HOME/config"

# Colours for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Colour

# Show usage
usage() {
    echo "Usage: send-file <file-path> [caption]"
    echo ""
    echo "Explicitly send a file to the user via web UI and Telegram."
    echo ""
    echo "Arguments:"
    echo "  file-path   Path to the file to send"
    echo "  caption     Optional message to send with the file"
    echo ""
    echo "Examples:"
    echo "  send-file ~/.myagentive/media/videos/demo.mp4"
    echo "  send-file ~/.myagentive/media/videos/demo.mp4 \"Here's your video!\""
    echo "  send-file /tmp/report.pdf \"Quarterly report\""
    exit 1
}

# Determine subdirectory based on file extension
get_subdir() {
    local ext="${1##*.}"
    ext=$(echo "$ext" | tr '[:upper:]' '[:lower:]')

    case "$ext" in
        mp4|mov|webm|avi|mkv|m4v) echo "videos" ;;
        mp3|wav|m4a|aac|flac|ogg|oga) echo "audio" ;;
        jpg|jpeg|png|gif|webp|svg|bmp|tiff) echo "photos" ;;
        *) echo "documents" ;;
    esac
}

# Get API key from config
get_api_key() {
    if [ -f "$API_KEY_FILE" ]; then
        grep -E "^API_KEY=" "$API_KEY_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d '"' | tr -d "'"
    fi
}

# Main
if [ $# -lt 1 ]; then
    usage
fi

SOURCE="$1"
CAPTION="${2:-}"

# Expand ~ in path
SOURCE="${SOURCE/#\~/$HOME}"

# Validate source file exists
if [ ! -f "$SOURCE" ]; then
    echo -e "${RED}Error: File not found: $SOURCE${NC}" >&2
    exit 1
fi

# Get absolute path
SOURCE=$(realpath "$SOURCE")
FILENAME=$(basename "$SOURCE")

# Check if file is already in media directory
if [[ "$SOURCE" == "$MEDIA_DIR"/* ]]; then
    # File is already in media directory
    FILE_PATH="$SOURCE"
else
    # Move file to media directory first
    SUBDIR=$(get_subdir "$FILENAME")
    TARGET_DIR="$MEDIA_DIR/$SUBDIR"
    mkdir -p "$TARGET_DIR"
    FILE_PATH="$TARGET_DIR/$FILENAME"

    if [ -f "$FILE_PATH" ]; then
        echo -e "${YELLOW}Warning: Overwriting existing file${NC}" >&2
    fi

    mv "$SOURCE" "$FILE_PATH"
    echo -e "${GREEN}Moved file to: $FILE_PATH${NC}"
fi

# Get API key
API_KEY=$(get_api_key)
if [ -z "$API_KEY" ]; then
    echo -e "${RED}Error: API_KEY not found in $API_KEY_FILE${NC}" >&2
    echo "Add API_KEY=your-key to your config file" >&2
    exit 1
fi

# Send file via API
echo "Sending file to user..."

RESPONSE=$(curl -s -X POST "$SERVER_URL/api/send-file" \
    -H "Content-Type: application/json" \
    -H "X-API-Key: $API_KEY" \
    -d "{\"filePath\": \"$FILE_PATH\", \"filename\": \"$FILENAME\", \"caption\": \"$CAPTION\"}")

# Check response
if echo "$RESPONSE" | grep -q '"success":true'; then
    echo -e "${GREEN}File sent successfully!${NC}"
    echo ""
    echo "  File: $FILE_PATH"
    echo "  Caption: ${CAPTION:-<none>}"
    echo ""
    # Output the path so frontend can detect it
    echo "Download available at: $FILE_PATH"
else
    ERROR=$(echo "$RESPONSE" | grep -o '"error":"[^"]*"' | cut -d'"' -f4)
    echo -e "${RED}Failed to send file: ${ERROR:-Unknown error}${NC}" >&2
    echo "Response: $RESPONSE" >&2
    exit 1
fi
