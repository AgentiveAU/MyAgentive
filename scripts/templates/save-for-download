#!/bin/bash
# save-for-download - Move files to MyAgentive media directory for web UI download
#
# Usage: save-for-download <source-file> [target-filename]
#
# Examples:
#   save-for-download /tmp/video.mp4
#   save-for-download /tmp/video.mp4 my-custom-name.mp4
#   save-for-download ./output.pdf report-2024.pdf

set -e

# Configuration
MYAGENTIVE_HOME="${MYAGENTIVE_HOME:-$HOME/.myagentive}"
MEDIA_DIR="$MYAGENTIVE_HOME/media"

# Colours for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Colour

# Show usage
usage() {
    echo "Usage: save-for-download <source-file> [target-filename]"
    echo ""
    echo "Move a file to the MyAgentive media directory for download via web UI."
    echo ""
    echo "Arguments:"
    echo "  source-file      Path to the file to save"
    echo "  target-filename  Optional: rename the file (default: keep original name)"
    echo ""
    echo "Examples:"
    echo "  save-for-download /tmp/video.mp4"
    echo "  save-for-download /tmp/video.mp4 presentation.mp4"
    echo "  save-for-download ./report.pdf quarterly-report.pdf"
    exit 1
}

# Determine subdirectory based on file extension
get_subdir() {
    local ext="${1##*.}"
    ext=$(echo "$ext" | tr '[:upper:]' '[:lower:]')

    case "$ext" in
        # Video
        mp4|mov|webm|avi|mkv|m4v)
            echo "videos"
            ;;
        # Audio
        mp3|wav|m4a|aac|flac|ogg|oga)
            echo "audio"
            ;;
        # Images
        jpg|jpeg|png|gif|webp|svg|bmp|tiff)
            echo "photos"
            ;;
        # Documents (everything else)
        *)
            echo "documents"
            ;;
    esac
}

# Main
if [ $# -lt 1 ]; then
    usage
fi

SOURCE="$1"
TARGET_NAME="${2:-$(basename "$SOURCE")}"

# Validate source file exists
if [ ! -f "$SOURCE" ]; then
    echo -e "${RED}Error: Source file not found: $SOURCE${NC}" >&2
    exit 1
fi

# Determine target subdirectory
SUBDIR=$(get_subdir "$TARGET_NAME")
TARGET_DIR="$MEDIA_DIR/$SUBDIR"

# Create target directory if needed
mkdir -p "$TARGET_DIR"

# Full target path
TARGET_PATH="$TARGET_DIR/$TARGET_NAME"

# Check if target already exists
if [ -f "$TARGET_PATH" ]; then
    echo -e "${YELLOW}Warning: Overwriting existing file${NC}" >&2
fi

# Move the file
mv "$SOURCE" "$TARGET_PATH"

# Get file size for display
FILE_SIZE=$(du -h "$TARGET_PATH" | cut -f1)

# Output success message with the path (this is what the frontend detects)
echo -e "${GREEN}File saved for download:${NC}"
echo ""
echo "  Path: $TARGET_PATH"
echo "  Size: $FILE_SIZE"
echo "  Type: $SUBDIR"
echo ""
echo "The file is now available at: $MYAGENTIVE_HOME/media/$SUBDIR/$TARGET_NAME"
